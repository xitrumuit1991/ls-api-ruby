!function(t){t.widget("ra.jcropForm",{_create:function(){var t=this,e=t.element,i=e.find("img.img-polaroid").parent();i.unbind().bind("click",function(i){return t._bindModalOpening(i,e.find("a.jcrop_handle").data("link")),!1})},_bindModalOpening:function(e,i){if(e.preventDefault(),widget=this,t("#modal").length)return!1;var a=this._getModal();setTimeout(function(){t.ajax({url:i,beforeSend:function(t){t.setRequestHeader("Accept","text/javascript")},success:function(t,e,i){a.find(".modal-body").html(t),widget._bindFormEvents()},error:function(t,e,i){a.find(".modal-body").html(t.responseText)},dataType:"text"})},100)},_bindFormEvents:function(){var e=this,i=this._getModal(),a=i.find("form"),n=i.find(":submit[name=_save]").html(),o=i.find(":submit[name=_continue]").html();i.find(".form-actions").remove();var d=t.extend({bgColor:"white",keySupport:!1,onSelect:e.updateCoordinates},rails_admin_jcrop_options);i.find("img.jcrop-subject").Jcrop(d),a.attr("data-remote",!0),i.find(".modal-header-title").text(a.data("title")),i.find(".cancel-action").unbind().click(function(){return i.modal("hide"),!1}).html(o),i.find(".save-action").unbind().click(function(){return a.submit(),!1}).html(n),t(document).trigger("rails_admin.dom_ready"),a.bind("ajax:complete",function(a,n,o){if("error"==o)i.find(".modal-body").html(n.responseText),e._bindFormEvents();else{var d=t.parseJSON(n.responseText);e.element.find("select").filter(":hidden");thumb=e.element.find("a.jcrop_handle").data("thumb"),e.element.find("img.img-polaroid").removeAttr("src").attr("src",d.urls[thumb]+"?"+(new Date).valueOf()),e._trigger("success"),i.modal("hide")}})},updateCoordinates:function(e){var i=100/e.w,a=100/e.h,n=t("img.jcrop-subject").width(),o=t("img.jcrop-subject").height(),d=t("img.jcrop-subject").data("geometry").split(",")[0]/n;t("#preview").css({width:Math.round(i*n)+"px",height:Math.round(a*o)+"px",marginLeft:"-"+Math.round(i*e.x)+"px",marginTop:"-"+Math.round(a*e.y)+"px"}),t("#crop_x").val(Math.round(e.x*d)),t("#crop_y").val(Math.round(e.y*d)),t("#crop_w").val(Math.round(e.w*d)),t("#crop_h").val(Math.round(e.h*d))},_getModal:function(){var e=this;return e.dialog||(e.dialog=t('<div id="modal" class="modal fade"><div class="modal-header"><a href="#" class="close" data-dismiss="modal">&times;</a><h3 class="modal-header-title">...</h3></div><div class="modal-body">...</div><div class="modal-footer"><a href="#" class="btn cancel-action">...</a><a href="#" class="btn btn-primary save-action">...</a></div></div>'),e.dialog.modal({keyboard:!0,backdrop:!0,show:!0}).on("hidden",function(){e.dialog.remove(),e.dialog=null})),this.dialog}})}(jQuery),$(function(){$("div.jcrop_type").jcropForm()});